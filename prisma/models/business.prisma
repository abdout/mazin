// Business Models
// This file contains all models related to shipments, invoices, and customs

// ============================================
// Shipment Models
// ============================================

model Shipment {
  id             String         @id @default(cuid())
  shipmentNumber String         @unique
  trackingNumber String?        @unique // Public tracking number (TRK-XXXXXX)
  type           ShipmentType
  status         ShipmentStatus @default(PENDING)

  // Cargo details
  description     String
  weight          Decimal?       @db.Decimal(10, 2)
  quantity        Int?
  containerNumber String?
  vesselName      String?

  // Parties
  consignor String // Shipper
  consignee String // Receiver

  // Dates
  arrivalDate   DateTime?
  departureDate DateTime?

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id])

  declarations   CustomsDeclaration[]
  invoices       Invoice[]
  trackingStages TrackingStage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shipmentNumber])
  @@index([trackingNumber])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@map("shipments")
}

enum ShipmentType {
  IMPORT
  EXPORT
}

enum ShipmentStatus {
  PENDING
  IN_TRANSIT
  ARRIVED
  CLEARED
  DELIVERED
}

// ============================================
// Customs Models
// ============================================

model CustomsDeclaration {
  id            String            @id @default(cuid())
  declarationNo String            @unique
  status        DeclarationStatus @default(DRAFT)

  hsCode     String?
  dutyAmount Decimal? @db.Decimal(15, 2)
  taxAmount  Decimal? @db.Decimal(15, 2)
  currency   String   @default("SDG")
  notes      String?

  // Relations
  shipmentId String
  shipment   Shipment @relation(fields: [shipmentId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  documents Document[]

  approvedAt DateTime?
  approvedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([declarationNo])
  @@index([status])
  @@index([shipmentId])
  @@map("customs_declarations")
}

enum DeclarationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

model Document {
  id       String       @id @default(cuid())
  fileName String
  fileUrl  String
  fileType DocumentType
  fileSize Int?

  declarationId String
  declaration   CustomsDeclaration @relation(fields: [declarationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("documents")
}

enum DocumentType {
  BILL_OF_LADING
  COMMERCIAL_INVOICE
  PACKING_LIST
  CERTIFICATE_OF_ORIGIN
  INSURANCE_CERTIFICATE
  OTHER
}

// ============================================
// Client Model
// ============================================

model Client {
  id               String   @id @default(cuid())
  companyName      String
  contactName      String?
  email            String?
  phone            String?
  taxId            String?

  // Billing Address
  billingAddress1  String
  billingAddress2  String?
  billingCity      String
  billingState     String?
  billingCountry   String   @default("SD")
  billingPostal    String?

  // Shipping Address (optional)
  shippingAddress1 String?
  shippingAddress2 String?
  shippingCity     String?
  shippingState    String?
  shippingCountry  String?
  shippingPostal   String?

  sameAsShipping   Boolean  @default(true)
  notes            String?
  isActive         Boolean  @default(true)

  // Relations
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  invoices         Invoice[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([companyName])
  @@index([email])
  @@index([userId])
  @@map("clients")
}

// ============================================
// Company Settings Model
// ============================================

model CompanySettings {
  id                  String   @id @default(cuid())

  // Company Identity
  companyName         String
  companyNameAr       String?
  taxId               String?

  // Contact Information
  email               String?
  phone               String?
  website             String?

  // Company Address
  address1            String?
  address2            String?
  city                String?
  state               String?
  country             String   @default("SD")
  postalCode          String?

  // Branding
  logoUrl             String?  @default("/logo.png")
  signatureUrl        String?  @default("/sign.png")
  primaryColor        String?

  // Invoice Defaults
  invoicePrefix       String   @default("INV")
  invoiceStartNum     Int      @default(1)
  defaultCurrency     String   @default("SDG")
  defaultTaxRate      Decimal  @default(15) @db.Decimal(5, 2)
  defaultPaymentTerms Int      @default(30)

  // Bank Details
  bankName            String?
  bankBranch          String?
  accountName         String?
  accountNumber       String?
  iban                String?
  swiftCode           String?

  // Default Text
  termsAndConditions  String?  @db.Text
  footerNote          String?

  // Relation
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id])

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("company_settings")
}

// ============================================
// Invoice Models
// ============================================

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  status        InvoiceStatus @default(DRAFT)

  currency String  @default("SDG")
  subtotal Decimal @db.Decimal(15, 2)
  tax      Decimal @default(0) @db.Decimal(15, 2)
  total    Decimal @db.Decimal(15, 2)

  dueDate DateTime?
  paidAt  DateTime?
  notes   String?

  // Client relationship
  clientId         String?
  client           Client?  @relation(fields: [clientId], references: [id])

  // Payment and terms
  paymentTermsDays Int?
  taxRate          Decimal? @db.Decimal(5, 2)
  taxLabel         String?  @default("VAT")
  referenceNumber  String?
  termsAndConditions String? @db.Text

  // Relations
  shipmentId String?
  shipment   Shipment? @relation(fields: [shipmentId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  items InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceNumber])
  @@index([status])
  @@index([userId])
  @@index([clientId])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model InvoiceItem {
  id          String  @id @default(cuid())
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(15, 2)
  total       Decimal @db.Decimal(15, 2)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invoice_items")
}

// ============================================
// Tracking Models
// ============================================

model TrackingStage {
  id         String              @id @default(cuid())
  shipmentId String
  shipment   Shipment            @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  stageType  TrackingStageType
  status     TrackingStageStatus @default(PENDING)

  // Timestamps
  startedAt   DateTime? // When stage was started
  completedAt DateTime? // When stage was completed
  estimatedAt DateTime? // ETA for this stage

  // Metadata
  notes       String? // Staff notes for this stage
  updatedById String? // User who last updated this stage

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shipmentId, stageType])
  @@index([shipmentId])
  @@index([status])
  @@map("tracking_stages")
}

enum TrackingStageType {
  PRE_ARRIVAL_DOCS
  VESSEL_ARRIVAL
  CUSTOMS_DECLARATION
  CUSTOMS_PAYMENT
  INSPECTION
  PORT_FEES
  QUALITY_STANDARDS
  RELEASE
  LOADING
  IN_TRANSIT
  DELIVERED
}

enum TrackingStageStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

// ============================================
// Project Model (Clearance Jobs)
// ============================================

model Project {
  id          String        @id @default(cuid())
  customer    String                        // Customer/Importer name
  blAwbNumber String?                       // Bill of Lading / AWB
  description String?       @db.Text        // Brief description
  status      ProjectStatus @default(PENDING)
  priority    ProjectPriority @default(MEDIUM)

  // Shipment info
  systems     String[]      @default([])    // Shipment types (stored as JSON array)
  portOfOrigin      String?
  portOfDestination String?

  // Team
  teamLead    String?
  team        String[]      @default([])    // Team member IDs

  // Dates
  startDate   DateTime?
  endDate     DateTime?

  // Relations
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  tasks       Task[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([customer])
  @@index([status])
  @@index([userId])
  @@map("projects")
}

enum ProjectStatus {
  PENDING
  IN_PROGRESS
  CUSTOMS_HOLD
  RELEASED
  DELIVERED
}

enum ProjectPriority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

// ============================================
// Task Model
// ============================================

model Task {
  id          String       @id @default(cuid())
  task        String                        // Task title
  project     String                        // Project reference (name)
  status      TaskStatus   @default(PENDING)
  priority    TaskPriority @default(MEDIUM)

  // Details
  desc        String?      @db.Text         // Description
  label       String?                       // Category label
  duration    String?                       // Estimated duration

  // Assignment
  assignedTo  String[]     @default([])     // Assigned team members

  // Dates
  date        DateTime?                     // Due date
  hours       Int?                          // Actual hours spent

  // Relations
  projectId   String?
  projectRef  Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId      String
  user        User         @relation(fields: [userId], references: [id])

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([status])
  @@index([projectId])
  @@index([userId])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  STUCK
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  URGENT
  HIGH
  MEDIUM
  LOW
}
